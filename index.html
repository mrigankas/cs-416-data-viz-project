<html lang="en">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" integrity="sha512-iBAeBWWWFb8HqSBcrqcz98iIpuVH1la39dEYHtyQ/pGpeCQTQVvLJOWAuhv2Q7JSHp9k7hWA7sGxU3hHJe+tFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>circle {fill: lightblue; stroke: black;}</style>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body onload="init()">
    <h1>Narrative Visualization</h1>
    <p>Under construction ...</p>
    <div id="navigation"></div>
    <p id="space1"></div>
    <label for="states">Select a state:</label>
    <!-- <select name="states" id="states">
        <option value="AL">Alabama</option>
        <option value="AK">Alaska</option>
        <option value="AZ">Arizona</option>
        <option value="AR">Arkansas</option>
        <option value="CA">California</option>
        <option value="CO">Colorado</option>
        <option value="CT">Connecticut</option>
        <option value="DE">Delaware</option>
        <option value="DC">District of Columbia</option>
        <option value="FL">Florida</option>
        <option value="GA">Georgia</option>
        <option value="HI">Hawaii</option>
        <option value="ID">Idaho</option>
        <option value="IL">Illinois</option>
        <option value="IN">Indiana</option>
        <option value="IA">Iowa</option>
        <option value="KS">Kansas</option>
        <option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option>
        <option value="ME">Maine</option>
        <option value="MD">Maryland</option>
        <option value="MA">Massachusetts</option>
        <option value="MI">Michigan</option>
        <option value="MN">Minnesota</option>
        <option value="MS">Mississippi</option>
        <option value="MO">Missouri</option>
        <option value="MT">Montana</option>
        <option value="NE">Nebraska</option>
        <option value="NV">Nevada</option>
        <option value="NH">New Hampshire</option>
        <option value="NJ">New Jersey</option>
        <option value="NM">New Mexico</option>
        <option value="NY">New York</option>
        <option value="NC">North Carolina</option>
        <option value="ND">North Dakota</option>
        <option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option>
        <option value="OR">Oregon</option>
        <option value="PA">Pennsylvania</option>
        <option value="PR">Puerto Rico</option>
        <option value="RI">Rhode Island</option>
        <option value="SC">South Carolina</option>
        <option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option>
        <option value="TX">Texas</option>
        <option value="UT">Utah</option>
        <option value="VT">Vermont</option>
        <option value="VA">Virginia</option>
        <option value="VI">Virgin Islands</option>
        <option value="WA">Washington</option>
        <option value="WV">West Virginia</option>
        <option value="WI">Wisconsin</option>
        <option value="WY">Wyoming</option>
    </select> -->
    <select></select>
    <!-- <svg width="800" height="800"></svg> -->
    <svg></svg>
    <script>
        
        var stateList = [
                [1, "AL", "Alabama"],
                [2, "AK", "Alaska"],
                [3, "AZ", "Arizona"],
                [4, "AR", "Arkansas"],
                [5, "CA", "California"],
                [6, "CO", "Colorado"],
                [7, "CT", "Connecticut"],
                [8, "DE", "Delaware"],
                [9, "DC", "District of Columbia"],
                [10, "FL", "Florida"],
                [11, "GA", "Georgia"],
                [12, "HI", "Hawaii"],
                [13, "ID", "Idaho"],
                [14, "IL", "Illinois"],
                [15, "IN", "Indiana"],
                [16, "IA", "Iowa"],
                [17, "KS", "Kansas"],
                [18, "KY", "Kentucky"],
                [19, "LA", "Louisiana"],
                [20, "ME", "Maine"],
                [21, "MD", "Maryland"],
                [22, "MA", "Massachusetts"],
                [23, "MI", "Michigan"],
                [24, "MN", "Minnesota"],
                [25, "MS", "Mississippi"],
                [26, "MO", "Missouri"],
                [27, "MT", "Montana"],
                [28, "NE", "Nebraska"],
                [29, "NV", "Nevada"],
                [30, "NH", "New Hampshire"],
                [31, "NJ", "New Jersey"],
                [32, "NM", "New Mexico"],
                [33, "NY", "New York"],
                [34, "NC", "North Carolina"],
                [35, "ND", "North Dakota"],
                [36, "OH", "Ohio"],
                [37, "OK", "Oklahoma"],
                [38, "OR", "Oregon"],
                [39, "PA", "Pennsylvania"],
                [40, "PR", "Puerto Rico"],
                [41, "RI", "Rhode Island"],
                [42, "SC", "South Carolina"],
                [43, "SD", "South Dakota"],
                [44, "TN", "Tennessee"],
                [45, "TX", "Texas"],
                [46, "UT", "Utah"],
                [47, "VT", "Vermont"],
                [48, "VA", "Virginia"],
                [49, "VI", "Virgin Islands"],
                [50, "WA", "Washington"],
                [51, "WV", "West Virginia"],
                [52, "WI", "Wisconsin"],
                [53, "WY", "Wyoming"]
            ]

        var buttonList = ["< Prev", "1", "2", "3", "Next >"];

        var width = 1200, height = 600;
        var margin = 100;

        var svg = d3.select("svg")
                    .attr("width", width)
                    .attr("height", height)
                    // .append("g")
                    //     // .attr("transform", "translate("+50+","+50+")")
                    //     .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
        

        function drawTitle(selectedState, filterAdultOrPediatric) {
            svg.append("g")
                // .data(stateList)
                .append("text")
                .attr("id", "chartTitle")
                .attr("x", (width/2 - margin))
                .attr("y", (margin/2))
                .style("font-size", "24px")
                .style("text-anchor", "center")
                .style("fill", "steelblue")
                .text(function() { 
                                        var stateName = ""; 
                                        for (var row of stateList) {
                                            if (row[1] === selectedState) {
                                                stateName = row[2];
                                                break;
                                            }
                                        } 
                                        
                                        return stateName + " Records for " + filterAdultOrPediatric + " Patients";
                                    })

        }

        function drawNavigation() {
            d3.select("#navigation")
                .selectAll("button")
                .data(buttonList)
                .enter()
                .append("button")
                .text(function(d) { return d; })
        }

        async function init() {

            var selectedState = "CA" //stateList[0][1];
            var selectedSlideNum = "1";
            var filterAdultOrPediatric = "Adult";


            // ============= Draw the Slide Navigation Buttons =============
            // var button = d3.selectAll("button")
            //                     .data(buttonList)
            //                     .enter()
            //                     .append("button")
            //                     .text(function(d) { return d; })
            
            drawNavigation()

            // ============== SCENE 1 - ADULTs =====================
            
            

            // =========== Populate the State Drop Down list =================
            var dropDown = d3.select("select")
                            .attr("id", "states")
            
            var options = dropDown.selectAll("option")
                                    .data(stateList)
                                    .enter()
                                    .append("option")
                                    .text(function(d) { return d[2]; })
                                    .attr("value", function(d) { return d[1]; })
                                    .property("selected", function(d) { return d[1] === selectedState; })

            const data = await d3.csv("us_statewise_covid_data_cleaned.csv");
            // const data = await d3.csv('https://flunky.github.io/cars2017.csv');
            
            
            //  ======== Draw the x axis ======== 
            var parseTime = d3.timeParse("%Y/%m/%d")
            // var dates = data.map(function(d) { return parseTime(d.date); })
            var dateDomain = d3.extent(data.map(function(d) { return parseTime(d.date); }))
            dateDomain = [d3.timeYear.floor(dateDomain[0]), d3.timeYear.ceil(dateDomain[1])]
            var xScale = d3.scaleTime().domain(dateDomain).range([0, width-margin])
            
            var xAxis = d3.axisBottom(xScale)
            // x axis is date            
            svg.append("g")
                    .attr("transform", "translate("+ margin/2 +","+ ((margin/2)+(height-margin)) +")")
                .call(xAxis.ticks())
            
            // ======== Draw the y axis ======== 
            // TODO: yMax should be constant and the maximum of all the charts variables to be shown
            var yMax = 5000;
            if (filterAdultOrPediatric === "Adult") {
                var hospAdults = data.map(function(d) { return parseInt(d.total_adult_patients_hospitalized_confirmed_and_suspected_covid); })
                var confAdults = data.map(function(d) { return parseInt(d.total_adult_patients_hospitalized_confirmed_covid); })
                yMax = d3.max([d3.max(hospAdults), d3.max(confAdults)])
            }
            
            // var deaths_covid = data.map(function(d) { return parseInt(d.deaths_covid);})
            // var yDomain = d3.extent(deaths_covid)
            var yDomain = [0, yMax]
            var yScale = d3.scaleLinear().domain(yDomain).range([height-margin, 0])

            var yAxis = d3.axisLeft(yScale)
            // y axis is case count
            svg.append("g")
                    .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
                .call(yAxis.ticks())

            // Total Covid hospitalized line
            var allHospitalizedAdultsLine = d3.line()
                .x(function(d) { return xScale(parseTime(d.date)); })
                .y(function(d) { return yScale(parseInt(d.total_adult_patients_hospitalized_confirmed_and_suspected_covid)); })

            // Total Covid hospitalized confirmed line
            var confirmedHospitalizedAdultsLine = d3.line()
                .x(function(d) { return xScale(parseTime(d.date)); })
                .y(function(d) { return yScale(parseInt(d.total_adult_patients_hospitalized_confirmed_covid)); })

            
            function drawLineChart(selectedState) {
                var filteredData = data.filter(function(d) { return d.state === selectedState; })
                
                drawTitle(selectedState, filterAdultOrPediatric)
                
                if (filterAdultOrPediatric === "Adult") {
                    
                    // svg.append("g")
                    //     // .data(stateList)
                    //     .append("text")
                    //     .attr("id", "chartTitle")
                    //     .attr("x", (width/2))
                    //     .attr("y", (margin/2))
                    //     .style("font-size", "24px")
                    //     .style("text-anchor", "center")
                    //     .style("fill", "steelblue")
                    //     .text(function() { 
                    //                             var stateName = ""; 
                    //                             for (var row of stateList) {
                    //                                 if (row[1] === selectedState) {
                    //                                     stateName = row[2];
                    //                                     break;
                    //                                 }
                    //                             } 
                                                
                    //                             return stateName + " Records for " + filterAdultOrPediatric + " Patients";
                    //                         })

                        
                    svg.append("g")
                            .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
                        .append("path")
                        .datum(filteredData)
                        .attr("id", "hospAdultsAll")
                        .attr("fill", "none")
                        .attr("stroke", "orange")
                        .attr("stroke-width", 2)
                        .attr("d", allHospitalizedAdultsLine)

                    svg.append("g")
                            .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
                        .append("path")
                        .datum(filteredData)
                        .attr("id", "hospAdultsConfirmed")
                        .attr("fill", "none")
                        .attr("stroke", "red")
                        .attr("stroke-width", 2)
                        .attr("d", confirmedHospitalizedAdultsLine)

                }
            }

            // var filteredData = data.filter(function(d) { return d.state === selectedState; })
            drawLineChart(selectedState)

            function updateChart(selectedState) {
                var filteredData = data.filter(function(d) { return d.state === selectedState; })
                d3.select("#chartTitle")                    
                    .remove()
                
                // svg.append("g")
                //     // .data(stateList)
                //     .append("text")
                //     .attr("id", "chartTitle")
                //     .attr("x", (width/2))
                //     .attr("y", (margin/2))
                //     .style("font-size", "24px")
                //     .style("text-anchor", "center")
                //     .style("fill", "steelblue")
                //     .text(function() { 
                //                             var stateName = ""; 
                //                             for (var row of stateList) {
                //                                 if (row[1] === selectedState) {
                //                                     stateName = row[2];
                //                                     break;
                //                                 }
                //                             }                                            
                //                             return stateName + " Records for " + filterAdultOrPediatric + " Patients";
                //                         })

                drawTitle(selectedState, filterAdultOrPediatric)

                if (filterAdultOrPediatric === "Adult") {                
                    d3.select("#hospAdultsAll")
                        .transition()
                        .duration(100)
                        .remove()
                    svg.append("g")
                            .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
                        .append("path")
                        .datum(filteredData)
                        .attr("id", "hospAdultsAll")
                        .transition()
                        .duration(1000)
                        .attr("fill", "none")
                        .attr("stroke", "orange")
                        .attr("stroke-width", 2)
                        .attr("d", allHospitalizedAdultsLine)

                    d3.select("#hospAdultsConfirmed")
                        .transition()
                        .duration(100)
                        .remove()
                    svg.append("g")
                            .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
                        .append("path")
                        .datum(filteredData)
                        .attr("id", "hospAdultsConfirmed")
                        .transition()
                        .duration(1000)
                        .attr("fill", "none")
                        .attr("stroke", "red")
                        .attr("stroke-width", 2)
                        .attr("d", confirmedHospitalizedAdultsLine)
                        
                }
            }

            // Change of variable 'State' should trigger updating the chart for that 'State'
            d3.select("#states")
                .on("change", function(d) {
                    var selectedState = d3.select(this).property("value")
                    updateChart(selectedState)
                })

            // // Total Covid Deaths line
            // var covidDeathLine = d3.line()
            //     .x(function(d) { return xScale(parseTime(d.date)); })
            //     .y(function(d) { return yScale(parseInt(d.deaths_covid)); })

            // svg.append("g")
            //         .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
            //     .append("path")
            //     .datum(data.filter(function(d) { return d.state === selectedState; }))
                
            //     .attr("fill", "none")
            //     .attr("stroke", "steelblue")
            //     .attr("stroke-width", 2)
            //     // .enter()
            //     // .append("path")
            //         // .attr("class", "line")
            //     .attr("d", covidDeathLine)
                
            // ==============================
            
            // svg.append("g")
            //         .attr("transform", "translate("+ margin/2 +","+ margin/2 +")")
            //     .selectAll("circle")
            //     .data(data)
            //     .enter()
            //     .append("circle")
            //     .filter(function(d) { return d.state === "CA"; })
            //         // .attr("cx", function(d,i) { return xs(d.total_adult_patients_hospitalized_confirmed_and_suspected_covid); })
            //         .attr("cx", function(d,i) { return xs(parseTime(d.date)); })
            //         .attr("cy", function(d,i) { return ys(parseInt(d.deaths_covid)); })
            //         .attr("r", "1")
            

            // d3.select("svg")
            //     .append("g")
            //         .attr("transform", "translate("+50+","+50+")")
            //     .selectAll("dot")
            //     .data(data)
            //     .enter()
            //     .append("circle")
            //         .attr("cx", function(d,i) { return xs(d.total_adult_patients_hospitalized_confirmed_and_suspected_covid); })
            //         .attr("cy", function(d,i) { return ys(d.deaths_covid); })
            //         // .attr("cx", function(d) { return xs(d.AverageCityMPG); } )
            //         // .attr("cy", function(d) { return ys(d.AverageHighwayMPG); })
            //         .attr("r", "1")
            //         // .attr("r", function(d) { return (2+parseInt(d.EngineCylinders)); })

            // d3.select("svg")
            //     .append("g")
            //         .attr("transform", "translate("+50+","+50+")")
            //     .call(d3.axisLeft(ys))

        }
    </script>
</body>
</html>